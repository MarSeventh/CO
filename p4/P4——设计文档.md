# P4——设计文档

#### 支持指令：add, sub, ori, lw, sw, beq, lui, jal, jr, nop

# 模块规格设计

## GRF

GRF模块为32个寄存器组成的寄存器堆，其中0号寄存器的值始终为0，**模块端口**定义如下：

| 信号名 | 方向 | 位宽 |       说明       |
| :----: | :--: | :--: | :--------------: |
|   WE   |  I   |  1   |    写使能信号    |
| reset  |  I   |  1   |   同步复位信号   |
|  clk   |  I   |  1   |     时钟信号     |
|   A1   |  I   |  5   | 读操作第1个地址  |
|   A2   |  I   |  5   | 读操作第2个地址  |
|   A3   |  I   |  5   |  写操作目标地址  |
|   WD   |  I   |  32  |     写操作数     |
|  RD1   |  O   |  32  | A1对应寄存器的值 |
|  RD2   |  O   |  32  | A2对应寄存器的值 |

**模块功能**定义如下：

| 序号 | 功能名称 |                           功能说明                           |
| :--: | :------: | :----------------------------------------------------------: |
|  1   |   复位   | 同步复位，当reset信号为1且时钟上升沿来临时，GRF中所有寄存器的值置为0 |
|  2   |   写入   |      当WE有效且时钟上升沿来临时，将WD写入A3对应寄存器中      |
|  3   |   读取   | 当时钟上升沿来临时，将A1对应寄存器中数据输出到RD1，将A2寄存器中的数据输出到RD2 |

## IFU

IFU由PC和IM组成，功能是改变PC的值，并输出对应的指令。**模块端口**定义如下：

| 信号名 | 方向 | 位宽 |                             说明                             |
| :----: | :--: | :--: | :----------------------------------------------------------: |
|  clk   |  I   |  1   |                           时钟信号                           |
| reset  |  I   |  1   |                         同步复位信号                         |
| PCsel  |  I   |  1   | PC输入的选择信号。<br>PCsel为1时，PC输入来源Badder<br>PCsel为0时，PC输入来源Adder。 |
| Badder |  I   |  32  |                  当PCsel为1时PC的输入来源。                  |
|   OP   |  O   |  32  |                         要取出的指令                         |
|  PCn   |  O   |  32  |                         输出值为PC+4                         |

**模块功能**定义如下：

| 序号 | 功能名称 |                           功能说明                           |
| :--: | :------: | :----------------------------------------------------------: |
|  1   |   复位   | 同步复位，当reset信号为1且时钟上升沿来临时，PC的值初始化为0x00003000 |
|  2   | 改变PC值 | 当PCsel为1时，PC值改变为Badder的输入值；当PCsel为0时，PC值改变为PC+4 |
|  3   |  取指令  |               将PC值对应IM中的指令从OP端口输出               |

## ALU

ALU为算数逻辑模块，用来实现算数逻辑操作。**模块端口**定义如下：

| 信号名  | 方向 | 位宽 |                描述                |
| :-----: | :--: | :--: | :--------------------------------: |
|  data1  |  I   |  32  |            输入操作数1             |
|  data2  |  I   |  32  |            输入操作数2             |
|   op    |  I   |  3   |  控制信号，控制ALU进行的运算类型   |
| result  |  O   |  32  |            输出运算结果            |
| compare |  O   |  2   | 若进行比较运算，输出两数的比较结果 |

**模块功能**定义如下:

| 序号 |        功能名称         |                           功能描述                           |
| :--: | :---------------------: | :----------------------------------------------------------: |
|  1   |     加法（无符号）      |                    op==000时，result=A+B                     |
|  2   |     减法（无符号）      |                     op=001时，result=A-B                     |
|  3   |         或运算          |                    op=010时，result=A\|B                     |
|  4   |   比较大小（无符号）    | op=011时，若：<br />A=B，compare=00<br />A<B，compare=01<br />A>B，compare=10 |
|  5   | 立即数加载至高位（lui） |          op=100时，result={data2[15:0],{16{1'b0}}}           |

## DM

DM为数据存储模块，由3072个32位寄存器组成，**模块端口**定义如下：

| 信号名  | 方向 | 位宽 |                  描述                   |
| :-----: | :--: | :--: | :-------------------------------------: |
|   clk   |  I   |  1   |                时钟信号                 |
|  reset  |  I   |  1   |              同步复位信号               |
| address |  I   |  32  |  要存入内存或者从内存中取出数据的地址   |
|   WD    |  I   |  32  |              要写入DM的值               |
|   WE    |  I   |  1   |               写使能信号                |
|   RE    |  I   |  1   |               读使能信号                |
| Output  |  O   |  32  | 当RE信号有效时，输出的address地址处的值 |

**模块功能**定义如下：

| 序号 | 功能名称 |                           功能描述                           |
| :--: | :------: | :----------------------------------------------------------: |
|  1   | 同步复位 | 当reset信号有效且时钟上升沿来临时，将RAM中数据全部置为0x00000000 |
|  2   |  存数据  | 当WE信号有效且时钟上升沿来临时，将WD的值写到address对应的地址中 |
|  3   |  取数据  |     当RE信号有效时，将address对应地址的数据从Output输出      |

## Badder

Badder为PC下一次取值的选择模块，**模块**端口定义如下：

| 信号名 | 方向 | 位宽 |                          描述                          |
| :----: | :--: | :--: | :----------------------------------------------------: |
|  PCn   |  I   |  32  |                          PC+4                          |
|  IMD   |  I   |  32  |                    当前指令的机器码                    |
|   RF   |  I   |  32  |                      GRF输出的RD1                      |
|  com   |  I   |  2   | 来自于ALU的compare端口，代表指令中两个比较数的大小关系 |
| Basel  |  I   |  3   |               控制信号，控制模块的输出值               |
| Baout  |  O   |  32  |                         输出值                         |

**模块功能**定义如下：

**模块功能**定义如下：

| 序号 |       功能名称       |                        功能描述                         |
| :--: | :------------------: | :-----------------------------------------------------: |
|  1   |     直接输出PC+4     | 当Basel==3‘b000时，或者当跳转条件不满足时，直接输出PC+4 |
|  2   | 输出PC+4+(offset<<2) |         当满足跳转条件时，输出PC+4+(offset<<2)          |
|  3   |    输出offset<<2     |            当Basel==3'b010时，输出offset<<2             |
|  4   |      输出RF的值      |              当Basel==3'b011时，输出RF的值              |

## Controller（控制器）

Controller单元用来产生各个多路选择器的选择信号以及其他各模块所需要的控制信号。**模块端口**定义如下：

|   信号名   | 数据位宽 | 方向 |                             描述                             |
| :--------: | :------: | :--: | :----------------------------------------------------------: |
|    IMD     |    32    |  I   |                     当前执行指令的机器码                     |
|   PCsel    |    1     |  O   |         为1时PC新的取值来自于Badder，否则直接为PC+4          |
|  (GRF)WE   |    1     |  O   | 当指令为add/sub/ori/lw/lui/jal时，输出1<br />其他指令输出0，作为GRF模块的写入使能信号 |
|  (ALU)OP   |    3     |  O   | 当指令为add/lw/sw时，输出为000，ALU进行加法运算<br />当指令为sub时，输出001，ALU进行减法运算<br />当指令为ori时，输出010，ALU进行或运算<br />当指令为lui时，输出为100，ALU将立即数加载至高位<br />当指令为beq时，输出为011，ALU进行比较运算 |
|   (DM)WE   |    1     |  O   |   当指令为sw时，输出为1，其他指令输出为0，接入DM的写使能端   |
|   (DM)RE   |    1     |  O   |   当指令为lw时，输出为1，其他指令输出为0，接入DM的读使能端   |
| (GRF)A3sel |    1     |  O   | 当指令为add/sub时，输出为2'b01,<br />指令为jal时，输出为2'b10，<br />其他指令输出2'00,<br />为GRF的A3端口前多路选择器的选择信号 |
|  ALUBsel   |    1     |  O   | 当指令为ori/lw/sw/lui时，输出为1，其他指令输出为0，为ALU的B操作数前多路选择器的选择信号 |
| (GRF)WDsel |    1     |  O   | 当指令为add/sub/ori/lui时，输出为2'b01,<br />指令为jal时，输出为2'b10，<br />其他指令输出为2'b00<br />作为GRF的WD端口前多路选择器的选择信号 |
|   Basel    |    3     |  O   | 当指令为beq时，输出3'b001<br />当指令为j/jal时，输出3'b010<br />当指令为jr时，输出3'b011<br />其他指令输出3'b000<br />作为Badder输出端的控制信号。 |
|   extsel   |    1     |  O   | 当指令为ori时，输出1，代表后16位立即数进行无符号扩展<br />其他指令输出0，代表16位立即数进行符号扩展 |

模块功能即根据输入的指令来输出相应的控制信号。

# 测试方案

首先单独测试了ALU、GRF等模块的功能，然后再将P3所用测试数据导入IM，进行CPU的整体测试。

**整体测试的第一轮**，发现执行完所有命令后DM中存储数据均为0，显然存在错误，经过单步调试发现DM中每次写入数据的地址都是0x00000000，经过进一步分析发现是将DM模块的address与GRF的RD1相接，显然是十分低级的错误。

**整体测试第二轮**，发现DM最终存储的数据个数少于应该存储的数据，经过逐步分析发现是lw指令出现错误，每次lw指令得到的数据均为0，再次查看DM模块的代码发现是在用assign给输出Output赋值时加了clk判断，导致每次向GRF中写入数据时，Output都正好变为0；

**整体测试第三轮**，发现每次在执行到beq指令时，PC的取值就会出现不定值，考虑是Badder模块存在问题，经过仔细调试，发现是定义com时定义了3位，显然又是十分低级的错误。

经过前三轮测试后进行提交，发现错误是向DM中写入数据的次数太少，分析是因为程序提前结束，应该是跳转指令出现问题，对Badder再次分析后，发现beq指令的立即数没有进行符号扩展，j/jal指令的立即数构造方法也不对，这一块显然是由于没有认真对照指令集编写造成的错误，应该引起警示。
