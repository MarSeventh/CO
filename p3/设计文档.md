# **模块规格设计**

## IFU（取指令单元）

IFU主要有PC和IM组成，起到控制PC的变化以及取出指令的功能。**模块端口**定义如下：

| 信号名 | 数据位宽 | 方向 |                             描述                             |
| :----: | :------: | :--: | :----------------------------------------------------------: |
|  clk   |    1     |  I   |                     时钟信号，上升沿有效                     |
| reset  |    1     |  I   | 异步复位信号，当reset有效时，将PC复位为初始地址（**0x00000000**)。<br>1:有效<br>0:无效 |
| PCsel  |    1     |  I   | PC输入的选择信号。<br>PCsel为1时，PC输入来源Badder<br>PCsel为0时，PC输入来源Adder。 |
| Badder |    32    |  I   |                  当PCsel为1时PC的输入来源。                  |
|   OP   |    32    |  O   |                         要取出的指令                         |
|  PCn   |    32    |  O   |                         输出值为PC+4                         |

**模块功能**定义如下：

| 序号 | 功能名称 |                           功能描述                           |
| :--: | :------: | :----------------------------------------------------------: |
|  1   |   复位   |        异步复位，当reset有效时，将PC复位为初始地址。         |
|  2   | 改变PC值 | 当PCsel为0时，将PC改变为PC+4；当PCsel为1时，将PC改变为Badder输出的值。 |



## GRF

GRF由32个寄存器组成，分别对应0~31号寄存器，其中0号寄存器的值恒为0。**模块端口**定义如下：

| 信号名 | 数据位宽 | 方向 |                             描述                             |
| :----: | :------: | :--: | :----------------------------------------------------------: |
| reset  |    1     |  I   | 异步复位信号，当reset有效时，将GRF中所有寄存器的值置为0。<br>1:有效<br>0:无效 |
|  clk   |    1     |  I   |                     时钟信号，上升沿有效                     |
|   WE   |    1     |  I   |  写使能信号<br>1:可向GRF中写入数据<br>0:不可向GRF中写入数据  |
|   A1   |    5     |  I   |    地址输入信号1，指定32个寄存器中的一个，将其值输出到RD1    |
|   A2   |    5     |  I   |    地址输入信号2，指定32个寄存器中的一个，将其值输出到RD2    |
|   A3   |    5     |  I   | 地址输入信号3，指定32个寄存器中的一个作为写入的目标寄存器。  |
|   WD   |    32    |  I   |                          待写入数据                          |
|  RD1   |    32    |  O   |                          输出信号1                           |
|  RD2   |    32    |  O   |                          输出信号2                           |

**模块功能**定义如下：

| 序号 | 功能名称 |                           功能说明                           |
| :--: | :------: | :----------------------------------------------------------: |
|  1   |   复位   |     异步复位，当reset信号为1时，GRF中所有寄存器的值置为0     |
|  2   |   写入   |     当WE有效且时钟上升沿来临时，将WD写入A3对应的寄存器中     |
|  3   |   读取   | 当时钟上升沿来临时，将A1对应寄存器中数据输出到RD1，将A2寄存器中的数据输出到RD2 |



## ALU（算术逻辑单元)

ALU主要用来实现算数运算操作。**模块端口**定义如下：

| 信号名  | 数据位宽 | 方向 |                描述                |
| :-----: | :------: | :--: | :--------------------------------: |
|  data1  |    32    |  I   |            输入操作数1             |
|  data2  |    32    |  I   |            输入操作数2             |
|   op    |    3     |  I   |  控制信号，控制ALU进行的运算类型   |
| result  |    32    |  O   |            输出运算结果            |
| compare |    2     |  O   | 若进行比较运算，输出两数的比较结果 |

**模块功能**定义如下：

| 序号 |        功能名称         |                           功能描述                           |
| :--: | :---------------------: | :----------------------------------------------------------: |
|  1   |     加法（无符号）      |                    op==000时，result=A+B                     |
|  2   |     减法（无符号）      |                     op=001时，result=A-B                     |
|  3   |         或运算          |                    op=010时，result=A\|B                     |
|  4   |   比较大小（无符号）    | op=011时，若：<br />A=B，compare=00<br />A<B，compare=01<br />A>B，compare=10 |
|  5   | 立即数加载至高位（lui） |          op=100时，result={data2[15:0],{16{1'b0}}}           |

## DM（数据存储器）

DM模块主要由RAM组成，功能是对内存进行存取操作。**模块端口**定义如下：

|  信号名  | 数据位宽 | 方向 |                             描述                             |
| :------: | :------: | :--: | :----------------------------------------------------------: |
|   clk    |    1     |  I   |                     时钟信号，上升沿有效                     |
|  reset   |    1     |  I   | 异步复位信号，当reset有效时，将RAM中存储数据置0x00000000。<br/>1:有效<br/>0:无效 |
| DMoutsel |    2     |  I   |                     Output端输出控制信号                     |
| address  |    32    |  I   |             要存入内存或者从内存中取出数据的地址             |
|    WD    |    32    |  I   |                         要写入DM的值                         |
|    WE    |    1     |  I   |        写使能信号，当WE有效时将WD写入address对应地址         |
|    RE    |    1     |  I   |       读使能信号，当RE有效时将address地址处的数据输出        |
|  Output  |    32    |  O   |           当RE信号有效时，输出的address地址处的值            |

**模块功能**定义如下：

| 序号 | 功能名称 |                           功能描述                           |
| :--: | :------: | :----------------------------------------------------------: |
|  1   | 异步复位 |       当reset信号有效时，将RAM中数据全部置为0x00000000       |
|  2   |  存数据  | 当WE信号有效且时钟上升沿来临时，将WD的值写到address对应的地址中 |
|  3   |  取数据  | 当RE信号有效时，将address对应地址的数据从Output输出<br />当DMoutsel==2'b00时，输出一个字<br />当DMoutsel==2'b01时，输出一个字节 |

## EXT（扩展单元）

EXT单元由logisim内置的bit extender实现，主要功能是实现数据位数的改变，满足某些特定位数要求。

## Badder

Badder单元用来控制当指令为beq等跳转指令时PC改变后的值。**模块端口**定义如下：

| 信号名  | 数据位宽 | 方向 |                          描述                          |
| :-----: | :------: | :--: | :----------------------------------------------------: |
|   ad1   |    32    |  I   |                   操作数1，值为PC+4                    |
|   ad2   |    32    |  I   |      操作数2，值来自于EXT单元，为指令对应的offset      |
| compare |    2     |  I   | 来自于ALU的compare端口，代表指令中两个比较数的大小关系 |
|  Baout  |    32    |  O   |        为进行加法运算后的输出值，代表PC新的取值        |

**模块功能**定义如下：

| 序号 |   功能名称   |                           功能描述                           |
| :--: | :----------: | :----------------------------------------------------------: |
|  1   | 判断PC的取值 | 当PCsel==1时，PC新的取值来自于本模块。<br />当compare==00时，输出PC+4+offset<br />否则，输出PC+4 |

## Controller（控制器）

Controller单元用来产生各个多路选择器的选择信号以及其他各模块所需要的控制信号。**模块端口**定义如下：

|   信号名   | 数据位宽 | 方向 |                             描述                             |
| :--------: | :------: | :--: | :----------------------------------------------------------: |
|     op     |    6     |  I   |                       操作码的26~31位                        |
|    func    |    6     |  I   |                        R型指令的0~5位                        |
|   PCsel    |    1     |  O   |      当指令为beq时，输出为1<br />为其他指令时，输出为0       |
|  (GRF)WE   |    1     |  O   | 当指令为add/sub/ori/lw/lui时，输出1<br />其他指令输出0，作为GRF模块的写入使能信号 |
|  (ALU)OP   |    3     |  O   | 当指令为add/lw/sw时，输出为000，ALU进行加法运算<br />当指令为sub时，输出001，ALU进行减法运算<br />当指令为ori时，输出010，ALU进行或运算<br />当指令为lui时，输出为100，ALU将立即数加载至高位<br />当指令为beq时，输出为011，ALU进行比较运算 |
|   (DM)WE   |    1     |  O   |   当指令为sw时，输出为1，其他指令输出为0，接入DM的写使能端   |
|   (DM)RE   |    1     |  O   |   当指令为lw时，输出为1，其他指令输出为0，接入DM的读使能端   |
| (GRF)A3sel |    1     |  O   | 当指令为add/sub时，输出为1，其他指令输出为0，为GRF的A3端口前多路选择器的选择信号 |
|  ALUBsel   |    1     |  O   | 当指令为ori/lw/sw/lui时，输出为1，其他指令输出为0，为ALU的B操作数前多路选择器的选择信号 |
| (GRF)WDsel |    1     |  O   | 当指令为add/sub/ori/lui时，输出为1，其他指令输出为0，作为GRF的WD端口前多路选择器的选择信号 |
| signextsel |    1     |  O   |   当指令为ori时，输出1，进行符号扩展，否则输出0，进行0扩展   |
|  DMoutsel  |    2     |  O   |     当指令为lw时，输出2'b00<br />当指令为lb时，输出2'b01     |

模块功能即根据输入的指令来输出相应的控制信号。

# 测试方案

测试方案按照本次设计的CPU可执行的所有功能逐条测试，在测试时充分考虑不同情况，同时将最终寄存器中的数据全部存入内存，将MARS执行完成后内存中的数据与CPU中最后DM中存储的数据进行比较，如果一致可以初步证明设计CPU的正确性。

## ori指令

**ori** $a0, $0, 123

**ori** $a1, $a0, 456

## lui指令

**lui** $a2, 123            # 符号位为 0 

**lui** $a3, 0xffff         # 符号位为 1 

**ori** $a3, $a3, 0xffff    # $a3 = -1

## add指令

**add** $s0, $a0, $a2      # 正正 

**add** $s1, $a0, $a3      # 正负 

**add** $s2, $a3, $a3      # 负负

## sw指令

**ori** $t0, $0, 0x0000 

**sw** $a0, 0($t0) 

**sw** $a1, 4($t0) 

**sw** $a2, 8($t0) 

**sw** $a3, 12($t0) 

**sw** $s0, 16($t0) 

**sw** $s1, 20($t0) 

**sw** $s2, 24($t0)

## lw指令

**lw** $a0, 0($t0) 

**lw** $a1, 12($t0) 

**sw** $a0, 28($t0) 

**sw** $a1, 32($t0)

## beq指令

**ori** $a0, $0, 1 

**ori** $a1, $0, 2 

**ori** $a2, $0, 1 

**beq** $a0, $a1, loop1     # 不相等 

**beq** $a0, $a2, loop2     # 相等 

loop1:

**sw** $a0, 36($t0) 

loop2:

**sw** $a1, 40($t0)

在进行完上述测试并提交后，发现存在测试点出现错误，根据测试点给出的错误数据进行分析，初步判断是ori指令执行时出现错误，检查后发现是ori指令执行时将后16位立即数进行了符号扩展

所以增加以下两条测试指令：

**lui** $t0,73567

**ori** $t0,$t0,65535

如果进行符号扩展，最终$t0的值为0xffffffff;而更改过后，输出结果为0x7777ffff，结果正确。

回到最初测试指令中进行分析，可以发现在测试ori指令时，我们使用的指令没有包含立即数最高位为1的情况，从而出现此问题。
